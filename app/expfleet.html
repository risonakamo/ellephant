<link rel="import" href="polymer/polymer/polymer-element.html">

<!--
  #wrap class states: no-expedition, completed, resupply

-->

<dom-module id="exp-fleet">
  <template>
    <style>
      :host
      {
        display: inline-block;
        position: relative;
        width: 250px;
        height: 100px;        
        box-sizing: border-box;
        /*background-color: rgba(255,255,255,.05);        */
        user-select: none;
        cursor: default;
      }

      #wrap
      {
        padding: 10px;
        padding-left: 13px;
      }

      #slide-box
      {
        width: 230px;
        height: 50px;
        overflow: hidden;
      }

      #timer
      {
        font-size: 40px;
      }

      #info
      {
        font-size: 40px;
        transition: color .4s;
      }

      #wrap.completed #info
      {
        color: #81c15e;
      }

      #wrap.no-expedition #info
      {
        color: #e50018;
      }

      #inner-slide
      {
        transition: transform .5s;
      }

      .slideup
      {
        transform: translateY(-50px);
      }

      #expedition-name
      {
        font-size: 20px;
        font-family: var(--font-light);
        color: #744b77;
        transition: color .4s;
      }

      #wrap.no-expedition #expedition-name
      {
        color: #660000;
      }

      #border
      {        
        width: 80%;
        /*border-bottom: 1px solid #e7e7e5;*/
        border-bottom: 1px solid #736f6c;
      }

      #border2
      {
        border-bottom: 2px solid #6d4d72;
        transition: width .5s;
      }

      .borders
      {
        position: absolute;
        bottom: 0;
        height: 0;
      }

      .face
      {
        position: absolute;
        height: 100%;
        bottom: 0;
        right: 0;
        z-index: -5;
        opacity: .2;
        -webkit-mask-image: linear-gradient(to right, rgba(0,0,0,0) 0%,rgba(0,0,0,0.66) 14%,rgba(0,0,0,1) 30%);
      }

      #wrap.resupply
      {
        background-color: rgba(150,120,68,.08);
      }

      #wrap.resupply #expedition-name
      {
        color: #967844;
      }
    </style>
    
    <div id="wrap">
      <div id="slide-box">
        <div id="inner-slide">
          <div id="timer">
            [[hour]]:[[min]]:[[sec]]
          </div>
          
          <div id="info">
            [[infoMessage]]
          </div>
        </div>
      </div>


      <div id="expedition-name">
        [[expNum]]
      </div>

      <div id="border" class="borders">
        <div id="border2" class="borders" style="width:[[barPercent]]%"></div>
      </div> 

      <img class="face" src="[[face]]">
    </div>

  </template>

  <script>
    class expFleet extends Polymer.Element
    {
      static get is()
      {
        return "exp-fleet";
      }
      
      static get properties()
      {
        return {
          
        };
      }

      ready()
      {
        super.ready();
                
        this.resupply=0;
        this.clearExpedition();
      }

      //obj data {expNum: number of expedition,timeComplete: completion time from api}
      loadExp(data)
      {
        if (this.loaded==1)
        {
          return;
        }

        this.loaded=1;
        this.wrapState("");
        this.$["inner-slide"].classList.remove("slideup");

        this.expNum=`EXPEDITION ${data.expNum}`;
        this.maxTime=data.maxTime;

        var timeleft=data.timeComplete-new Date().getTime()-60000;

        if (timeleft<0)
        {
          this.complete();
          return;
        }

        this.sec=Math.floor((timeleft/1000)%60);
        this.min=Math.floor((timeleft/(1000*60))%60);
        this.hour=Math.floor((timeleft/(1000*60*60))%24);
        this.formatTime();

        this.updateBar();

        this.timer=setInterval(()=>{this.updateTime()},1000);
      }

      complete()
      {        
        clearTimeout(this.timer);

        this.infoMessage="Completed";
        this.wrapState("completed");
        this.$["inner-slide"].classList.add("slideup");
      }

      clearExpedition()
      {
        clearTimeout(this.timer);
        this.loaded=0;

        this.infoMessage="No Expedition";

        if (this.resupply==0)
        {
          this.expNum="NO EXPEDITION";
        }

        this.barPercent=0;
        this.wrapState("no-expedition");
        this.$["inner-slide"].classList.add("slideup");
      }      

      updateTime()
      {
        if (this.sec==0)
        {
          if (this.min==0)
          {
            if (this.hour==0)
            {
              this.complete();
              this.updateBar();
              return;
            }

            this.hour--;
            this.min=59;

            if (this.hour<10)
            {
              this.hour="0"+this.hour;
            }

            this.updateBar();
            return;
          }

          this.min--;
          this.sec=59;

          if (this.min<10)
          {
            this.min="0"+this.min;
          }

          this.updateBar();
          return;
        }

        this.sec--;   
        if (this.sec<10)
        {
          this.sec="0"+this.sec;
        }        
      }

      formatTime()
      {
        if (this.sec<10)
        {
          this.sec="0"+this.sec;
        }

        if (this.min<10)
        {
          this.min="0"+this.min;
        }

        if (this.hour<10)
        {
          this.hour="0"+this.hour;
        }        
      }

      updateBar()
      {
        this.barPercent=100-((((parseInt(this.hour)*60)+parseInt(this.min))/this.maxTime)*100);
      }

      /*set supply warnings
        0: normal
        1: requires refuel*/
      supplyState(state)
      {
        if (state==0)
        {
          this.resupply=0;
          this.$["wrap"].classList.remove("resupply");
          this.expNum="NO EXPEDITION";
        }

        else
        {
          this.resupply=1;
          this.expNum="RESUPPLY REQUIRED";
          this.$["wrap"].classList.add("resupply");
        }
      }

      //change css wrap state
      wrapState(state)
      {
        this.$["wrap"].classList.remove("no-expedition","completed");

        if (state==undefined || state=="")
        {
          return;
        }

        this.$["wrap"].classList.add(state);
      }
    }

    customElements.define(expFleet.is,expFleet);
  </script>
</dom-module>